import {
  core.external {sleep},
  core.file.descriptor {stdout},
  this.move.flush {flush},
  this.move.make-ansi-kit {make-ansi-kit, make-ansi-kit-unbuffered},
  this.move.write {write, write-code, writef},
  this.rule.ansi-kit {ansi-kit},
  this.rule.color {Color-ANSI},
  this.rule.color-ansi {
    Black,
    Blue,
    Cyan,
    Green,
    Magenta,
    Red,
    White,
    Yellow,
  },
  this.rule.color-intensity {Dull, Vivid},
  this.rule.color-layer {Background, Foreground},
  this.rule.command {Erase, Move-Cursor, Set-Style},
  this.rule.cursor-movement {Backward, To-Column},
  this.rule.space {Line},
  this.rule.span {From-Cursor, To-Cursor, Whole},
  this.rule.style {Bold, Color, Faint, Italic, Normal, Underline},
}

define _write-XX(k: &ansi-kit): unit {
  write(k, "XX");
  write-code(k, Set-Style(Normal));
  write(k, " ")
}

define _test-color-foreground-dull(k: &ansi-kit): unit {
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Dull, Black))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Dull, Red))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Dull, Green))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Dull, Yellow))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Dull, Blue))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Dull, Magenta))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Dull, Cyan))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Dull, White))));
  _write-XX(k)
}

define _test-color-background-dull(k: &ansi-kit): unit {
  write-code(k, Set-Style(Color(Background, Color-ANSI(Dull, Black))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Dull, Red))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Dull, Green))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Dull, Yellow))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Dull, Blue))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Dull, Magenta))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Dull, Cyan))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Dull, White))));
  _write-XX(k)
}

define _test-color-foreground-vivid(k: &ansi-kit): unit {
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Vivid, Black))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Vivid, Red))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Vivid, Green))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Vivid, Yellow))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Vivid, Blue))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Vivid, Magenta))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Vivid, Cyan))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Foreground, Color-ANSI(Vivid, White))));
  _write-XX(k)
}

define _test-color-background-vivid(k: &ansi-kit): unit {
  write-code(k, Set-Style(Color(Background, Color-ANSI(Vivid, Black))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Vivid, Red))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Vivid, Green))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Vivid, Yellow))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Vivid, Blue))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Vivid, Magenta))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Vivid, Cyan))));
  _write-XX(k);
  write-code(k, Set-Style(Color(Background, Color-ANSI(Vivid, White))));
  _write-XX(k)
}

define _test-color(k: &ansi-kit): unit {
  write-code(k, Set-Style(Normal));
  _write-XX(k);
  write-code(k, Set-Style(Bold));
  _write-XX(k);
  write-code(k, Set-Style(Faint));
  _write-XX(k);
  write-code(k, Set-Style(Italic));
  _write-XX(k);
  write-code(k, Set-Style(Underline));
  _write-XX(k);
  write(k, "\n");
  _test-color-foreground-dull(k);
  write(k, "\n");
  _test-color-background-dull(k);
  write(k, "\n");
  _test-color-foreground-vivid(k);
  write(k, "\n");
  _test-color-background-vivid(k);
  write(k, "\n");
  write(k, "123456789");
  flush(k);
  sleep(1);
  write-code(k, Erase(Line, Whole));
  write-code(k, Move-Cursor(To-Column(0)));
  write(k, "123456789");
  write-code(k, Move-Cursor(Backward(5)));
  flush(k);
  sleep(1);
  write-code(k, Erase(Line, From-Cursor));
  write(k, "\n");
  write(k, "123456789");
  write-code(k, Move-Cursor(Backward(5)));
  flush(k);
  sleep(1);
  write-code(k, Erase(Line, To-Cursor));
  flush(k);
  sleep(1);
  write(k, "\n");
  writef(k, "hello, {}!\n", [*"world"]);
  flush(k)
}

define zen(): unit {
  pin k1 = make-ansi-kit of {sink = stdout, capacity = 100} in
  pin k2 = make-ansi-kit-unbuffered of {sink = stdout} in
  _test-color(k1);
  _test-color(k2)
}

define main(): unit {
  zen()
}
