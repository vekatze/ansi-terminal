import {
  core.int.show {show-int, show-uint},
  core.text.buffer,
  this.rule.ansi-kit {_ANSI-Kit, _ANSI-Kit-Unbuffered, ansi-kit},
  this.rule.color {Color-256, Color-ANSI, Color-RGB},
  this.rule.color-ansi {
    Black,
    Blue,
    Cyan,
    Green,
    Magenta,
    Red,
    White,
    Yellow,
  },
  this.rule.color-intensity {Dull, Vivid},
  this.rule.color-layer {Background, Foreground},
  this.rule.command {Erase, Move-Cursor, Set-Style, command},
  this.rule.cursor-movement {Backward, Down, Down-Start, Forward, To, To-Column, Up, Up-Start},
  this.rule.space {Line, Screen},
  this.rule.span {From-Cursor, To-Cursor, Whole},
  this.rule.style {Bold, Color, Faint, Italic, Normal, Underline},
}

define write(k: &ansi-kit, t: &text): unit {
  case k {
  | _ANSI-Kit of {buffer} =>
    core.text.buffer.write(buffer, t)
  | _ANSI-Kit-Unbuffered =>
    let _ = core.text.io.write(admit, admit) in
    Unit
  }
}

define writef(k: &ansi-kit, t: &text, args: list(text)): unit {
  case k {
  | _ANSI-Kit of {buffer} =>
    core.text.buffer.writef(buffer, t, args)
  | _ANSI-Kit-Unbuffered =>
    admit
  }
}

define _write(k: &ansi-kit, t: &text): unit {
  case k {
  | _ANSI-Kit of {buffer} =>
    core.text.buffer.write(buffer, t)
  | _ANSI-Kit-Unbuffered =>
    admit
  }
}

define _writef(k: &ansi-kit, t: &text, args: list(text)): unit {
  case k {
  | _ANSI-Kit of {buffer} =>
    core.text.buffer.writef(buffer, t, args)
  | _ANSI-Kit-Unbuffered =>
    admit
  }
}

inline write-code(k: &ansi-kit, c: command): unit {
  match c {
  | Set-Style(style) =>
    match style {
    | Normal =>
      _write(k, "\u{1b}[0m")
    | Bold =>
      _write(k, "\u{1b}[1m")
    | Faint =>
      _write(k, "\u{1b}[2m")
    | Italic =>
      _write(k, "\u{1b}[3m")
    | Underline =>
      _write(k, "\u{1b}[4m")
    | Color(color-layer, color) =>
      match color-layer {
      | Foreground =>
        match color {
        | Color-ANSI(color-intensity, color) =>
          match color-intensity {
          | Dull =>
            match color {
            | Black =>
              _write(k, "\u{1b}[30m")
            | Red =>
              _write(k, "\u{1b}[31m")
            | Green =>
              _write(k, "\u{1b}[32m")
            | Yellow =>
              _write(k, "\u{1b}[33m")
            | Blue =>
              _write(k, "\u{1b}[34m")
            | Magenta =>
              _write(k, "\u{1b}[35m")
            | Cyan =>
              _write(k, "\u{1b}[36m")
            | White =>
              _write(k, "\u{1b}[37m")
            }
          | Vivid =>
            match color {
            | Black =>
              _write(k, "\u{1b}[90m")
            | Red =>
              _write(k, "\u{1b}[91m")
            | Green =>
              _write(k, "\u{1b}[92m")
            | Yellow =>
              _write(k, "\u{1b}[93m")
            | Blue =>
              _write(k, "\u{1b}[94m")
            | Magenta =>
              _write(k, "\u{1b}[95m")
            | Cyan =>
              _write(k, "\u{1b}[96m")
            | White =>
              _write(k, "\u{1b}[97m")
            }
          }
        | Color-256(value) =>
          _writef(k, "\u{1b}[38;5;{}m]", [show-uint(zext-int8-int(value))])
        | Color-RGB(r, g, b) =>
          _writef(k, "\u{1b}[38;2;{};{};{}m]", [
            show-uint(zext-int8-int(r)),
            show-uint(zext-int8-int(g)),
            show-uint(zext-int8-int(b)),
          ])
        }
      | Background =>
        match color {
        | Color-ANSI(color-intensity, color) =>
          match color-intensity {
          | Dull =>
            match color {
            | Black =>
              _write(k, "\u{1b}[40m")
            | Red =>
              _write(k, "\u{1b}[41m")
            | Green =>
              _write(k, "\u{1b}[42m")
            | Yellow =>
              _write(k, "\u{1b}[43m")
            | Blue =>
              _write(k, "\u{1b}[44m")
            | Magenta =>
              _write(k, "\u{1b}[45m")
            | Cyan =>
              _write(k, "\u{1b}[46m")
            | White =>
              _write(k, "\u{1b}[47m")
            }
          | Vivid =>
            match color {
            | Black =>
              _write(k, "\u{1b}[100m")
            | Red =>
              _write(k, "\u{1b}[101m")
            | Green =>
              _write(k, "\u{1b}[102m")
            | Yellow =>
              _write(k, "\u{1b}[103m")
            | Blue =>
              _write(k, "\u{1b}[104m")
            | Magenta =>
              _write(k, "\u{1b}[105m")
            | Cyan =>
              _write(k, "\u{1b}[106m")
            | White =>
              _write(k, "\u{1b}[107m")
            }
          }
        | Color-256(value) =>
          _writef(k, "\u{1b}[48;5;{}m]", [show-uint(zext-int8-int(value))])
        | Color-RGB(r, g, b) =>
          _writef(k, "\u{1b}[48;2;{};{};{}m]", [
            show-uint(zext-int8-int(r)),
            show-uint(zext-int8-int(g)),
            show-uint(zext-int8-int(b)),
          ])
        }
      }
    }
  | Move-Cursor(movement) =>
    match movement {
    | Up(offset) =>
      _writef(k, "\u{1b}[{}A", [show-int(offset)])
    | Down(offset) =>
      _writef(k, "\u{1b}[{}B", [show-int(offset)])
    | Forward(offset) =>
      _writef(k, "\u{1b}[{}C", [show-int(offset)])
    | Backward(offset) =>
      _writef(k, "\u{1b}[{}D", [show-int(offset)])
    | Up-Start(offset) =>
      _writef(k, "\u{1b}[{}E", [show-int(offset)])
    | Down-Start(offset) =>
      _writef(k, "\u{1b}[{}F", [show-int(offset)])
    | To-Column(column) =>
      _writef(k, "\u{1b}[{}G", [show-int(column)])
    | To(x, y) =>
      _writef(k, "\u{1b}[{};{}H", [show-int(x), show-int(y)])
    }
  | Erase(space, span) =>
    match space {
    | Line =>
      match span {
      | From-Cursor =>
        _write(k, "\u{1b}[0K")
      | To-Cursor =>
        _write(k, "\u{1b}[1K")
      | Whole =>
        _write(k, "\u{1b}[2K")
      }
    | Screen =>
      match span {
      | From-Cursor =>
        _write(k, "\u{1b}[0J")
      | To-Cursor =>
        _write(k, "\u{1b}[1J")
      | Whole =>
        _write(k, "\u{1b}[2J")
      }
    }
  }
}
